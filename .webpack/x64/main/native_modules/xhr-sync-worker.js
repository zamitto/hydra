"use strict";const util=require("util"),{JSDOM}=require("../../../.."),{READY_STATES}=require("./xhr-utils"),idlUtils=require("../generated/utils"),tough=require("tough-cookie"),dom=new JSDOM,xhr=new dom.window.XMLHttpRequest,xhrImpl=idlUtils.implForWrapper(xhr),chunks=[];process.stdin.on("data",(r=>{chunks.push(r)})),process.stdin.on("end",(()=>{const r=Buffer.concat(chunks),e=JSON.parse(r.toString());e.body&&"Buffer"===e.body.type&&e.body.data&&(e.body=Buffer.from(e.body.data)),e.cookieJar&&(e.cookieJar=tough.CookieJar.fromJSON(e.cookieJar)),e.synchronous=!1,Object.assign(xhrImpl.flag,e);const{properties:t}=xhrImpl;xhrImpl.readyState=READY_STATES.OPENED;try{xhr.addEventListener("loadend",(()=>{t.error&&(t.error=t.error.stack||util.inspect(t.error)),process.stdout.write(JSON.stringify({responseURL:xhrImpl.responseURL,status:xhrImpl.status,statusText:xhrImpl.statusText,properties:t}),(()=>{process.exit(0)}))}),!1),xhr.send(e.body)}catch(r){t.error+=r.stack||util.inspect(r),process.stdout.write(JSON.stringify({responseURL:xhrImpl.responseURL,status:xhrImpl.status,statusText:xhrImpl.statusText,properties:t}),(()=>{process.exit(0)}))}}));